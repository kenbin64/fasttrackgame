<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FastTrack! - Create Private Game</title>
    <link rel="icon" href="assets/images/ftLogo.png" type="image/png">
    <link rel="apple-touch-icon" href="assets/images/ftLogo.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/play.css">
</head>
<body>
    <div class="bg-animation"></div>

    <!-- Header -->
    <div class="header">
        <h1 class="logo">FastTrack!</h1>
        <p class="tagline">üîí Create a Private Game</p>
    </div>

    <!-- ========== STEP 1: CREATE GAME FORM ========== -->
    <div id="step-create" class="screen active">
        <div class="card">
            <h2 class="card-title">üöÄ Create Private Game</h2>
            <p style="color: var(--text-muted); margin-bottom: 20px;">
                Set up your game, get a code, and invite friends!
            </p>

            <div class="form-group">
                <label>Your Username</label>
                <input type="text" id="create-username" placeholder="Enter your name..." maxlength="20" autocomplete="off">
            </div>

            <div class="avatar-section">
                <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-muted);">
                    Choose Your Avatar
                </label>
                <div class="avatar-preview">
                    <div class="avatar-preview-large" id="avatar-preview">üë§</div>
                    <div>
                        <div style="font-weight: 600;" id="avatar-name">Select an avatar</div>
                        <div style="font-size: 0.85em; color: var(--text-muted);">100+ to choose from!</div>
                    </div>
                </div>

                <div class="avatar-categories" id="avatar-categories"></div>
                <div class="avatar-grid" id="avatar-grid"></div>

                <div class="upload-avatar">
                    <input type="file" id="avatar-upload" accept="image/*">
                    <label for="avatar-upload">üì∑ Upload Custom Avatar</label>
                </div>
            </div>

            <!-- Game Settings -->
            <h3 style="margin: 25px 0 15px; color: var(--text); font-size: 1.1em;">‚öôÔ∏è Game Settings</h3>

            <div class="settings-row">
                <span class="settings-label">Max Players</span>
                <div class="settings-value">
                    <select id="create-max-players">
                        <option value="2">2 Players</option>
                        <option value="3">3 Players</option>
                        <option value="4" selected>4 Players</option>
                        <option value="5">5 Players</option>
                        <option value="6">6 Players</option>
                    </select>
                </div>
            </div>

            <div class="settings-row">
                <span class="settings-label">Allow AI Bots</span>
                <div class="settings-value">
                    <label class="toggle-switch">
                        <input type="checkbox" id="setting-allow-bots" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>

            <div class="settings-row">
                <span class="settings-label">Allow Late Joiners</span>
                <div class="settings-value">
                    <label class="toggle-switch">
                        <input type="checkbox" id="setting-late-join" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>

            <div class="settings-row">
                <span class="settings-label">Music</span>
                <div class="settings-value">
                    <label class="toggle-switch">
                        <input type="checkbox" id="setting-music" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>

            <div class="btn-group">
                <a href="index.html" class="btn btn-secondary">‚Üê Back</a>
                <button class="btn btn-success btn-lg" id="create-btn" onclick="createGame()">
                    üöÄ Create Game
                </button>
            </div>
        </div>
    </div>

    <!-- ========== STEP 2: GAME CREATED ‚Äî SHARE CODE ========== -->
    <div id="step-created" class="screen">
        <div class="session-code-display">
            <div class="session-code-label">Your Game Code ‚Äî share with friends:</div>
            <div class="session-code" id="game-code">------</div>
            <div class="session-code-actions">
                <button class="copy-btn" onclick="copyCode()">üìã Copy Code</button>
                <button class="copy-btn" onclick="copyLink()">üîó Copy Link</button>
                <button class="invite-btn" onclick="showInviteModal()">üì® Invite Players</button>
            </div>
        </div>

        <div class="card" style="text-align: center;">
            <h2 class="card-title" style="justify-content: center;">‚úÖ Game Created!</h2>
            <p style="color: var(--text-muted); margin-bottom: 15px;">
                Share the code above with your friends. They can join at:
            </p>
            <p style="color: var(--secondary); font-weight: 600; margin-bottom: 25px; word-break: break-all;" id="join-url-display"></p>

            <div class="btn-group" style="flex-direction: column; gap: 12px;">
                <button class="btn btn-success btn-lg" onclick="enterWaitingRoom()" style="padding: 18px;">
                    üéÆ Enter Waiting Room
                </button>
                <p style="color: var(--text-muted); font-size: 0.85em;">
                    Wait for players to join, then start when ready.
                </p>
            </div>
        </div>

        <div class="card">
            <h3 style="margin-bottom: 12px; font-size: 1em;">üìú Quick Rules</h3>
            <ul style="color: var(--text-muted); font-size: 0.9em; line-height: 1.8; padding-left: 18px;">
                <li>Play cards to move pegs around the board</li>
                <li>Get all 4 pegs from Start to Home to win</li>
                <li>Jack or Joker needed to leave Start</li>
                <li>Land on an opponent to send them back</li>
                <li>Joker is wild ‚Äî can be any card</li>
            </ul>
        </div>
    </div>

    <!-- ========== STEP 3: HOST WAITING ROOM ========== -->
    <div id="step-waiting" class="screen">
        <div class="session-code-display">
            <div class="session-code-label">Game Code ‚Äî share with friends:</div>
            <div class="session-code" id="waiting-game-code">------</div>
            <div class="session-code-actions">
                <button class="copy-btn" onclick="copyCode()">üìã Copy Code</button>
                <button class="copy-btn" onclick="copyLink()">üîó Copy Link</button>
                <button class="invite-btn" onclick="showInviteModal()">üì® Invite</button>
            </div>
        </div>

        <div class="card">
            <h2 class="card-title" style="justify-content: center;">‚è≥ Waiting Room</h2>
            <p style="color: var(--text-muted); text-align: center; margin-bottom: 20px;">
                Waiting for players to join... Share the code above!
            </p>

            <!-- Player Slots -->
            <div id="player-slots" style="display: flex; flex-wrap: wrap; gap: 12px; justify-content: center; margin-bottom: 20px;"></div>

            <!-- Host Ready Toggle -->
            <div style="text-align: center; margin-bottom: 20px;">
                <button class="btn btn-secondary btn-lg" id="ready-toggle-btn" onclick="toggleReady()" style="padding: 14px 32px; min-width: 200px;">
                    ‚òê I'm Ready
                </button>
            </div>

            <!-- Host Controls -->
            <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-bottom: 15px;">
                <button class="btn btn-secondary" onclick="addBot()" id="add-bot-btn">ü§ñ Add Bot</button>
                <button class="btn btn-secondary" onclick="removeBot()" id="remove-bot-btn" style="display: none;">‚ûñ Remove Bot</button>
            </div>

            <div id="player-count-info" style="text-align: center; color: var(--text-muted); font-size: 0.9em; margin-bottom: 20px;"></div>

            <div style="text-align: center;">
                <button class="btn btn-success btn-lg" id="start-game-btn" onclick="startGame()" disabled style="padding: 18px; min-width: 250px;">
                    üéÆ Start Game
                </button>
                <p id="start-game-note" style="color: var(--text-muted); font-size: 0.85em; margin-top: 10px;">
                    Everyone must be ready to start
                </p>
            </div>
        </div>

        <div class="card" style="text-align: center;">
            <button class="btn btn-secondary" onclick="cancelGame()" style="opacity: 0.7;">
                ‚úñ Cancel Game
            </button>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast"></div>

    <!-- Invite Modal -->
    <div id="invite-modal" class="modal-overlay" onclick="closeInviteModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-title">üì® Invite Friends to Play!</div>
            <div class="modal-subtitle">Share the game code so your friends can join</div>

            <div class="share-code-box">
                <div class="share-code-label">Game Code</div>
                <div class="share-code-value" id="modal-game-code">------</div>
            </div>

            <div class="share-buttons">
                <button class="share-btn native" onclick="shareNative()" id="native-share-btn">
                    <span class="share-btn-icon">üì§</span> Share
                </button>
                <button class="share-btn whatsapp" onclick="shareWhatsApp()">
                    <span class="share-btn-icon">üí¨</span> WhatsApp
                </button>
                <button class="share-btn telegram" onclick="shareTelegram()">
                    <span class="share-btn-icon">‚úàÔ∏è</span> Telegram
                </button>
                <button class="share-btn twitter" onclick="shareTwitter()">
                    <span class="share-btn-icon">üê¶</span> Twitter/X
                </button>
                <button class="share-btn facebook" onclick="shareFacebook()">
                    <span class="share-btn-icon">üìò</span> Facebook
                </button>
                <button class="share-btn sms" onclick="shareSMS()">
                    <span class="share-btn-icon">üí¨</span> SMS
                </button>
                <button class="share-btn email" onclick="shareEmail()">
                    <span class="share-btn-icon">üìß</span> Email
                </button>
            </div>

            <button class="modal-close" onclick="closeInviteModal()">Close</button>
        </div>
    </div>

    <script>
        // =================================================================
        // AVATAR DATA
        // =================================================================
        const AVATARS = {
            people: {
                label: 'üë• People',
                items: [
                    'üë®üèª', 'üë®üèº', 'üë®üèΩ', 'üë®üèæ', 'üë®üèø', 'üë©üèª', 'üë©üèº', 'üë©üèΩ', 'üë©üèæ', 'üë©üèø',
                    'üßëüèª', 'üßëüèº', 'üßëüèΩ', 'üßëüèæ', 'üßëüèø', 'üë¶üèª', 'üë¶üèΩ', 'üë¶üèø', 'üëßüèª', 'üëßüèΩ', 'üëßüèø',
                    'üë¥üèª', 'üë¥üèΩ', 'üë¥üèø', 'üëµüèª', 'üëµüèΩ', 'üëµüèø', 'üßìüèª', 'üßìüèΩ', 'üßìüèø',
                    'üë®üèª‚Äçü¶∞', 'üë®üèΩ‚Äçü¶∞', 'üë®üèø‚Äçü¶∞', 'üë©üèº‚Äçü¶∞', 'üë©üèæ‚Äçü¶∞', 'üë©üèø‚Äçü¶∞',
                    'üë®üèª‚Äçü¶±', 'üë®üèΩ‚Äçü¶±', 'üë®üèø‚Äçü¶±', 'üë©üèº‚Äçü¶±', 'üë©üèæ‚Äçü¶±', 'üë©üèø‚Äçü¶±',
                    'üë®üèª‚Äçü¶≤', 'üë®üèΩ‚Äçü¶≤', 'üë®üèø‚Äçü¶≤', 'üë©üèº‚Äçü¶≤', 'üë©üèæ‚Äçü¶≤',
                    'üë®üèª‚Äçü¶≥', 'üë®üèΩ‚Äçü¶≥', 'üë®üèø‚Äçü¶≥', 'üë©üèº‚Äçü¶≥', 'üë©üèæ‚Äçü¶≥', 'üë©üèø‚Äçü¶≥',
                    'üë±üèª‚Äç‚ôÇÔ∏è', 'üë±üèΩ‚Äç‚ôÇÔ∏è', 'üë±üèø‚Äç‚ôÇÔ∏è', 'üë±üèª‚Äç‚ôÄÔ∏è', 'üë±üèΩ‚Äç‚ôÄÔ∏è', 'üë±üèø‚Äç‚ôÄÔ∏è',
                    'üßîüèª', 'üßîüèΩ', 'üßîüèø', 'üßîüèª‚Äç‚ôÇÔ∏è', 'üßîüèΩ‚Äç‚ôÇÔ∏è', 'üßîüèø‚Äç‚ôÇÔ∏è',
                    'üë≤üèª', 'üë≤üèΩ', 'üë≤üèø', 'üë≥üèª‚Äç‚ôÇÔ∏è', 'üë≥üèΩ‚Äç‚ôÇÔ∏è', 'üë≥üèø‚Äç‚ôÇÔ∏è', 'üë≥üèª‚Äç‚ôÄÔ∏è', 'üë≥üèΩ‚Äç‚ôÄÔ∏è', 'üë≥üèø‚Äç‚ôÄÔ∏è',
                    'üßïüèª', 'üßïüèΩ', 'üßïüèø', 'üëÆüèª‚Äç‚ôÇÔ∏è', 'üëÆüèΩ‚Äç‚ôÄÔ∏è', 'üëÆüèø‚Äç‚ôÇÔ∏è',
                    'üë∑üèª‚Äç‚ôÇÔ∏è', 'üë∑üèΩ‚Äç‚ôÄÔ∏è', 'üë∑üèø‚Äç‚ôÇÔ∏è', 'üíÇüèª‚Äç‚ôÇÔ∏è', 'üíÇüèΩ‚Äç‚ôÄÔ∏è', 'üíÇüèø‚Äç‚ôÇÔ∏è',
                    'üïµüèªÔ∏è‚Äç‚ôÇÔ∏è', 'üïµüèΩÔ∏è‚Äç‚ôÄÔ∏è', 'üïµüèøÔ∏è‚Äç‚ôÇÔ∏è',
                    'üë®üèª‚Äç‚öïÔ∏è', 'üë©üèΩ‚Äç‚öïÔ∏è', 'üë®üèø‚Äç‚öïÔ∏è', 'üë®üèº‚Äçüåæ', 'üë©üèæ‚Äçüåæ', 'üë®üèø‚Äçüç≥', 'üë©üèª‚Äçüç≥',
                    'üë®üèΩ‚Äçüéì', 'üë©üèø‚Äçüéì', 'üë®üèª‚Äçüé§', 'üë©üèæ‚Äçüé§', 'üë®üèø‚Äçüè´', 'üë©üèº‚Äçüè´',
                    'üë®üèΩ‚Äçüíª', 'üë©üèø‚Äçüíª', 'üë®üèª‚Äçüíº', 'üë©üèæ‚Äçüíº', 'üë®üèø‚Äçüî¨', 'üë©üèº‚Äçüî¨',
                    'üë®üèª‚Äçüé®', 'üë©üèΩ‚Äçüé®', 'üë®üèø‚ÄçüöÄ', 'üë©üèº‚ÄçüöÄ', 'üë®üèæ‚Äç‚úàÔ∏è', 'üë©üèª‚Äç‚úàÔ∏è',
                    'ü•∑', 'ü•∑üèª', 'ü•∑üèΩ', 'ü•∑üèø', 'ü¶∏üèª‚Äç‚ôÇÔ∏è', 'ü¶∏üèΩ‚Äç‚ôÄÔ∏è', 'ü¶∏üèø‚Äç‚ôÇÔ∏è',
                    'ü¶πüèª‚Äç‚ôÄÔ∏è', 'ü¶πüèΩ‚Äç‚ôÇÔ∏è', 'ü¶πüèø‚Äç‚ôÄÔ∏è', 'üßôüèª‚Äç‚ôÇÔ∏è', 'üßôüèΩ‚Äç‚ôÄÔ∏è', 'üßôüèø‚Äç‚ôÇÔ∏è',
                    'üßöüèª‚Äç‚ôÄÔ∏è', 'üßöüèΩ‚Äç‚ôÇÔ∏è', 'üßöüèø‚Äç‚ôÄÔ∏è', 'üßõüèª‚Äç‚ôÇÔ∏è', 'üßõüèΩ‚Äç‚ôÄÔ∏è', 'üßõüèø‚Äç‚ôÇÔ∏è',
                    'üßúüèª‚Äç‚ôÄÔ∏è', 'üßúüèΩ‚Äç‚ôÇÔ∏è', 'üßúüèø‚Äç‚ôÄÔ∏è', 'üßùüèª‚Äç‚ôÇÔ∏è', 'üßùüèΩ‚Äç‚ôÄÔ∏è', 'üßùüèø‚Äç‚ôÇÔ∏è',
                    'üíÉüèª', 'üíÉüèΩ', 'üíÉüèø', 'üï∫üèª', 'üï∫üèΩ', 'üï∫üèø', 'ü§¥üèª', 'ü§¥üèΩ', 'ü§¥üèø', 'üë∏üèª', 'üë∏üèΩ', 'üë∏üèø'
                ]
            },
            animals: {
                label: 'üêæ Animals',
                items: [
                    'üê∂', 'üê±', 'üê≠', 'üêπ', 'üê∞', 'ü¶ä', 'üêª', 'üêº', 'üêª‚Äç‚ùÑÔ∏è',
                    'üê®', 'üêØ', 'ü¶Å', 'üêÆ', 'üê∑', 'üê∏', 'üêµ', 'üôà', 'üôâ', 'üôä',
                    'üêî', 'üêß', 'üê¶', 'üê§', 'üê£', 'ü¶Ü', 'ü¶Ö', 'ü¶â', 'ü¶á',
                    'üê∫', 'üêó', 'üê¥', 'ü¶Ñ', 'üêù', 'ü™±', 'üêõ', 'ü¶ã', 'üêå',
                    'üêû', 'üêú', 'ü™∞', 'ü™≤', 'ü™≥', 'ü¶ü', 'ü¶ó', 'üï∑Ô∏è', 'ü¶Ç',
                    'üê¢', 'üêç', 'ü¶é', 'ü¶ñ', 'ü¶ï', 'üêô', 'ü¶ë', 'ü¶ê', 'ü¶û',
                    'ü¶Ä', 'üê°', 'üê†', 'üêü', 'üê¨', 'üê≥', 'üêã', 'ü¶à', 'üêä',
                    'üêÖ', 'üêÜ', 'ü¶ì', 'ü¶ç', 'ü¶ß', 'üêò', 'ü¶õ', 'ü¶è', 'üê™', 'üê´',
                    'ü¶í', 'ü¶ò', 'ü¶¨', 'üêÉ', 'üêÇ', 'üêÑ', 'üêé', 'üêñ', 'üêè', 'üêë',
                    'ü¶ô', 'üêê', 'ü¶å', 'üêï', 'üê©', 'ü¶Æ', 'üêï‚Äçü¶∫', 'üêà', 'üêà‚Äç‚¨õ'
                ]
            },
            fantasy: {
                label: 'ü¶Ñ Fantasy',
                items: [
                    'üëª', 'üíÄ', '‚ò†Ô∏è', 'üëΩ', 'üëæ', 'ü§ñ', 'üéÉ', 'üòà', 'üëø',
                    'üëπ', 'üë∫', 'üß†', 'üëÅÔ∏è', 'ü´Ä', 'ü¶¥', 'üåü', '‚≠ê', 'üí´',
                    '‚ú®', 'üî•', 'üíß', 'üåä', 'üåà', '‚òÄÔ∏è', 'üåô', '‚ö°', '‚ùÑÔ∏è',
                    'üå∏', 'üå∫', 'üåª', 'üåπ', 'üçÄ', 'üå¥', 'üåµ', 'üéÑ', 'üå≤',
                    'üçÑ', 'ü™®', 'üíé', 'üîÆ', 'ü™Ñ', 'üõ∏', 'üöÄ', 'üåç', 'üåé', 'üåè'
                ]
            },
            food: {
                label: 'üçï Food',
                items: [
                    'üçé', 'üçä', 'üçã', 'üçå', 'üçâ', 'üçá', 'üçì', 'ü´ê', 'üçí',
                    'üçë', 'ü•≠', 'üçç', 'ü••', 'ü•ù', 'üçÖ', 'ü•ë', 'ü•¶', 'ü•¨',
                    'ü•ï', 'üåΩ', 'üå∂Ô∏è', 'ü´ë', 'ü•í', 'ü•ú', 'üßÑ', 'üßÖ', 'ü•î',
                    'üç†', 'üçï', 'üçî', 'üçü', 'üå≠', 'üçø', 'ü•™', 'üåÆ', 'üåØ',
                    'ü•ó', 'ü•ò', 'üçù', 'üçú', 'üç≤', 'üçõ', 'üç£', 'üç±', 'ü•ü',
                    'üç§', 'üçô', 'üçö', 'üçò', 'ü•Æ', 'üç•', 'ü•†', 'üç¶', 'üçß',
                    'üç®', 'üç©', 'üç™', 'üéÇ', 'üç∞', 'üßÅ', 'ü•ß', 'üç´', 'üç¨',
                    'üç≠', 'üçÆ', '‚òï', 'üçµ', 'üßã', 'ü•§', 'üßÉ', 'üç∫', 'üçª'
                ]
            },
            objects: {
                label: 'üéÆ Objects',
                items: [
                    '‚öΩ', 'üèÄ', 'üèà', '‚öæ', 'ü•é', 'üéæ', 'üèê', 'üèâ', 'ü•è',
                    'üé±', 'ü™Ä', 'üèì', 'üè∏', 'üèí', 'üèë', 'ü•ç', 'üèè', 'ü™É',
                    'ü•Ö', '‚õ≥', 'ü™Å', 'üèπ', 'üé£', 'ü§ø', 'ü•ä', 'ü•ã', 'üéΩ',
                    'üõπ', 'üõº', 'üõ∑', '‚õ∏Ô∏è', 'ü•å', 'üéø', '‚õ∑Ô∏è', 'üèÇ', 'ü™Ç',
                    'üèãÔ∏è', 'ü§º', 'ü§∏', '‚õπÔ∏è', 'ü§æ', 'üèåÔ∏è', 'üßò', 'üé™', 'üé≠',
                    'üé®', 'üé¨', 'üé§', 'üéß', 'üéº', 'üéπ', 'ü•Å', 'ü™ò', 'üé∑',
                    'üé∫', 'ü™ó', 'üé∏', 'ü™ï', 'üéª', 'üé≤', '‚ôüÔ∏è', 'üéØ', 'üé≥',
                    'üéÆ', 'üïπÔ∏è', 'üß©', 'üé∞', 'üß∏', 'ü™Ü', 'üñºÔ∏è', 'üßµ', 'üß∂'
                ]
            }
        };

        // =================================================================
        // STATE
        // =================================================================
        let ws = null;
        let myUserId = null;
        let myUsername = null;
        let selectedAvatar = 'üë§';
        let customAvatarUrl = null;
        let sessionCode = null;
        let sessionData = null;

        // WebSocket URL
        const WS_URL = (() => {
            const isSecure = window.location.protocol === 'https:';
            const hostname = window.location.hostname;
            const wsProtocol = isSecure ? 'wss:' : 'ws:';
            if (hostname === 'localhost' || hostname === '127.0.0.1') {
                return wsProtocol + '//' + hostname + ':8765';
            }
            return wsProtocol + '//' + hostname + '/ws';
        })();

        // =================================================================
        // UI
        // =================================================================
        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(function(s) { s.classList.remove('active'); });
            document.getElementById(id).classList.add('active');
        }

        function showToast(message, type) {
            type = type || 'info';
            var toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show ' + type;
            setTimeout(function() { toast.classList.remove('show'); }, 3000);
        }

        // =================================================================
        // AVATARS
        // =================================================================
        function renderAvatarGrid() {
            var cats = document.getElementById('avatar-categories');
            var grid = document.getElementById('avatar-grid');
            var keys = Object.keys(AVATARS);

            cats.innerHTML = keys.map(function(key, i) {
                return '<button class="avatar-category-btn ' + (i === 0 ? 'active' : '') + '" onclick="switchCategory(\'' + key + '\')">' + AVATARS[key].label + '</button>';
            }).join('');

            switchCategory(keys[0]);

            document.getElementById('avatar-upload').addEventListener('change', function(e) {
                var file = e.target.files[0];
                if (file) {
                    var reader = new FileReader();
                    reader.onload = function(ev) {
                        customAvatarUrl = ev.target.result;
                        selectedAvatar = 'custom';
                        document.getElementById('avatar-preview').innerHTML =
                            '<img src="' + customAvatarUrl + '" alt="Custom" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">';
                        document.getElementById('avatar-name').textContent = 'Custom Avatar';
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        function switchCategory(category) {
            var cats = document.getElementById('avatar-categories');
            var grid = document.getElementById('avatar-grid');
            var label = AVATARS[category].label;

            cats.querySelectorAll('.avatar-category-btn').forEach(function(btn) {
                btn.classList.toggle('active', btn.textContent === label);
            });

            grid.innerHTML = AVATARS[category].items.map(function(avatar) {
                return '<div class="avatar-option ' + (selectedAvatar === avatar ? 'selected' : '') + '" onclick="selectAvatar(\'' + avatar + '\')">' + avatar + '</div>';
            }).join('');
        }

        function selectAvatar(avatar) {
            selectedAvatar = avatar;
            customAvatarUrl = null;
            document.getElementById('avatar-preview').textContent = avatar;
            document.getElementById('avatar-name').textContent = 'Selected!';
            document.querySelectorAll('#avatar-grid .avatar-option').forEach(function(el) {
                el.classList.toggle('selected', el.textContent === avatar);
            });
        }

        // =================================================================
        // WEBSOCKET
        // =================================================================
        function connectWebSocket() {
            return new Promise(function(resolve, reject) {
                if (ws && ws.readyState === WebSocket.OPEN) return resolve();

                ws = new WebSocket(WS_URL);
                ws.onopen = function() {
                    console.log('[Create] WebSocket connected');
                    resolve();
                };
                ws.onmessage = function(event) {
                    try {
                        var data = JSON.parse(event.data);
                        handleMessage(data);
                    } catch (e) {
                        console.error('[Create] Parse error:', e);
                    }
                };
                ws.onerror = function(err) {
                    console.error('[Create] WebSocket error:', err);
                    reject(err);
                };
                ws.onclose = function() {
                    console.log('[Create] WebSocket closed');
                    ws = null;
                    // Auto-reconnect if in waiting room
                    if (sessionCode && document.getElementById('step-waiting').classList.contains('active')) {
                        console.log('[Create] Reconnecting in 3s...');
                        setTimeout(function() {
                            connectWebSocket().then(function() {
                                send({ type: 'guest_login', name: myUsername, avatar_id: selectedAvatar });
                            }).catch(function() {
                                showToast('Connection lost. Trying to reconnect...', 'error');
                            });
                        }, 3000);
                    }
                };
                setTimeout(function() {
                    if (ws && ws.readyState !== WebSocket.OPEN) {
                        reject(new Error('Connection timeout'));
                    }
                }, 5000);
            });
        }

        function send(data) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(data));
            }
        }

        function handleMessage(data) {
            console.log('[Create] Server:', data.type, data);

            switch (data.type) {
                case 'auth_success':
                    myUserId = data.user.user_id;
                    myUsername = data.user.username;
                    console.log('[Create] Logged in as', myUsername, myUserId);
                    sendCreateSession();
                    break;

                case 'session_created':
                    sessionCode = data.share_code || (data.session && data.session.session_code);
                    sessionData = data.session;
                    showGameCreated();
                    break;

                case 'player_joined':
                    // A player was admitted to the session
                    if (sessionData) {
                        sessionData.players = data.players;
                    }
                    showToast((data.player ? data.player.username : 'A player') + ' joined!', 'success');
                    renderWaitingRoom();
                    break;

                case 'player_left':
                    if (sessionData) {
                        sessionData.players = data.players;
                    }
                    showToast((data.username || 'A player') + ' left', 'info');
                    renderWaitingRoom();
                    break;

                case 'player_ready_changed':
                    // A player toggled ready
                    if (sessionData) {
                        sessionData.players = data.players;
                    }
                    renderWaitingRoom();
                    break;

                case 'game_started':
                    // Server confirmed game start ‚Äî navigate to board
                    sessionData = data.session || sessionData;
                    navigateToBoard();
                    break;

                case 'session_updated':
                    if (data.session) {
                        sessionData = data.session;
                        renderWaitingRoom();
                    }
                    break;

                case 'error':
                    showToast(data.message || 'Something went wrong', 'error');
                    var btn = document.getElementById('create-btn');
                    if (btn) {
                        btn.disabled = false;
                        btn.innerHTML = 'üöÄ Create Game';
                    }
                    break;
            }
        }

        // =================================================================
        // CREATE GAME FLOW
        // =================================================================
        function createGame() {
            var username = document.getElementById('create-username').value.trim();

            if (!username) {
                showToast('Please enter a username', 'error');
                return;
            }
            if (username.length < 2) {
                showToast('Username must be at least 2 characters', 'error');
                return;
            }
            if (selectedAvatar === 'üë§') {
                showToast('Please select an avatar', 'error');
                return;
            }

            var btn = document.getElementById('create-btn');
            btn.disabled = true;
            btn.innerHTML = '‚è≥ Creating...';

            connectWebSocket().then(function() {
                // Step 1: Guest login
                myUsername = username;
                send({
                    type: 'guest_login',
                    name: username,
                    avatar_id: selectedAvatar
                });
                // Step 2 (sendCreateSession) is triggered by auth_success handler
            }).catch(function(e) {
                console.error('[Create] Connection failed:', e);
                showToast('Could not connect to server. Please try again.', 'error');
                btn.disabled = false;
                btn.innerHTML = 'üöÄ Create Game';
            });
        }

        function sendCreateSession() {
            var maxPlayers = parseInt(document.getElementById('create-max-players').value);
            var allowBots = document.getElementById('setting-allow-bots').checked;
            var allowLateJoin = document.getElementById('setting-late-join').checked;
            var musicEnabled = document.getElementById('setting-music').checked;

            send({
                type: 'create_session',
                private: true,
                max_players: maxPlayers,
                settings: {
                    allow_bots: allowBots,
                    allow_late_join: allowLateJoin,
                    music_enabled: musicEnabled
                }
            });
        }

        // =================================================================
        // GAME CREATED ‚Äî SHOW CODE
        // =================================================================
        function showGameCreated() {
            document.getElementById('game-code').textContent = sessionCode;
            document.getElementById('modal-game-code').textContent = sessionCode;

            var joinUrl = window.location.origin + '/fasttrack/join.html?code=' + sessionCode;
            document.getElementById('join-url-display').textContent = joinUrl;

            showScreen('step-created');
        }

        function enterWaitingRoom() {
            document.getElementById('waiting-game-code').textContent = sessionCode;
            showScreen('step-waiting');
            // Host is always ready ‚Äî send toggle_ready immediately
            send({ type: 'toggle_ready' });
            renderWaitingRoom();
        }

        // =================================================================
        // WAITING ROOM LOGIC
        // =================================================================
        function renderWaitingRoom() {
            if (!sessionData) return;

            var maxPlayers = sessionData.max_players || 4;
            var players = sessionData.players || [];
            var slotsHtml = '';

            for (var i = 0; i < maxPlayers; i++) {
                var player = players.find(function(p) { return p.slot === i; });
                if (player) {
                    var isHost = player.user_id === (sessionData.host_id || myUserId);
                    var isAI = player.is_ai;
                    var isReady = player.is_ai || player.ready;
                    var borderColor = isReady ? '#4ade80' : (isHost ? '#f59e0b' : '#666');
                    slotsHtml += '<div style="background: rgba(255,255,255,0.1); border: 2px solid ' + borderColor + '; border-radius: 14px; padding: 14px 18px; min-width: 110px; text-align: center; position: relative;">';
                    slotsHtml += '<div style="font-size: 2em;">' + getAvatarEmoji(player.avatar_id) + '</div>';
                    slotsHtml += '<div style="font-weight: 600; color: #fff; margin-top: 4px;">' + escapeHtml(player.username) + '</div>';
                    if (isHost) slotsHtml += '<div style="font-size: 0.75em; color: #f59e0b;">üëë Host</div>';
                    if (isAI) {
                        slotsHtml += '<div style="font-size: 0.75em; color: #8b5cf6;">ü§ñ Bot</div>';
                    } else {
                        slotsHtml += '<div style="font-size: 0.8em; margin-top: 4px; color: ' + (isReady ? '#4ade80' : '#888') + ';">' + (isReady ? '‚úÖ Ready' : '‚è≥ Not Ready') + '</div>';
                    }
                    slotsHtml += '</div>';
                } else {
                    slotsHtml += '<div style="background: rgba(255,255,255,0.03); border: 2px dashed rgba(255,255,255,0.15); border-radius: 14px; padding: 14px 18px; min-width: 110px; text-align: center;">';
                    slotsHtml += '<div style="font-size: 2em; opacity: 0.3;">‚ùì</div>';
                    slotsHtml += '<div style="color: rgba(255,255,255,0.3); margin-top: 4px;">Waiting...</div>';
                    slotsHtml += '</div>';
                }
            }
            document.getElementById('player-slots').innerHTML = slotsHtml;

            // Update host ready toggle button
            var myPlayer = players.find(function(p) { return p.user_id === myUserId; });
            var readyBtn = document.getElementById('ready-toggle-btn');
            if (readyBtn && myPlayer) {
                var amReady = myPlayer.ready;
                readyBtn.innerHTML = amReady ? '‚úÖ I\'m Ready!' : '‚òê I\'m Ready';
                readyBtn.className = amReady ? 'btn btn-success btn-lg' : 'btn btn-secondary btn-lg';
            }

            // Update bot buttons
            var aiCount = players.filter(function(p) { return p.is_ai; }).length;
            var totalPlayers = players.length;
            var canAddBot = totalPlayers < maxPlayers && aiCount < 3;
            document.getElementById('add-bot-btn').style.display = canAddBot ? 'inline-flex' : 'none';
            document.getElementById('remove-bot-btn').style.display = aiCount > 0 ? 'inline-flex' : 'none';

            // Player count info
            var humanCount = totalPlayers - aiCount;
            var readyCount = players.filter(function(p) { return p.is_ai || p.ready; }).length;
            document.getElementById('player-count-info').textContent =
                readyCount + '/' + totalPlayers + ' ready ‚Äî ' + totalPlayers + '/' + maxPlayers + ' slots filled';

            // Start button ‚Äî need at least 2 players AND all non-host humans ready
            var startBtn = document.getElementById('start-game-btn');
            var nonHostHumans = players.filter(function(p) { return !p.is_ai && p.user_id !== myUserId; });
            var allOthersReady = nonHostHumans.length === 0 || nonHostHumans.every(function(p) { return p.ready; });
            var canStart = totalPlayers >= 2 && allOthersReady;
            startBtn.disabled = !canStart;
            if (totalPlayers < 2) {
                document.getElementById('start-game-note').textContent = 'Need at least 2 players';
            } else if (!allOthersReady) {
                var notReady = nonHostHumans.filter(function(p) { return !p.ready; }).map(function(p) { return p.username; });
                document.getElementById('start-game-note').textContent = 'Waiting for: ' + notReady.join(', ');
            } else {
                document.getElementById('start-game-note').textContent = 'Everyone\'s ready! Start the game!';
            }
        }

        function toggleReady() {
            send({ type: 'toggle_ready' });
        }

        function addBot() {
            send({ type: 'add_ai_player' });
        }

        function removeBot() {
            if (!sessionData || !sessionData.players) return;
            var bots = sessionData.players.filter(function(p) { return p.is_ai; });
            if (bots.length > 0) {
                send({ type: 'remove_ai_player', player_id: bots[bots.length - 1].user_id });
            }
        }

        function startGame() {
            var btn = document.getElementById('start-game-btn');
            btn.disabled = true;
            btn.innerHTML = '‚è≥ Starting...';
            send({ type: 'start_game' });
        }

        function cancelGame() {
            if (confirm('Are you sure you want to cancel this game?')) {
                send({ type: 'leave_session' });
                if (ws) ws.close();
                ws = null;
                sessionCode = null;
                sessionData = null;
                showScreen('step-create');
                showToast('Game cancelled', 'info');
            }
        }

        function navigateToBoard() {
            // Store session info for board_3d.html
            var gameData = {
                session: sessionData,
                playerId: myUserId,
                username: myUsername,
                avatarId: selectedAvatar,
                avatarUrl: customAvatarUrl,
                wsUrl: WS_URL,
                isHost: true,
                sessionCode: sessionCode,
                timestamp: Date.now()
            };
            sessionStorage.setItem('fasttrack_session', JSON.stringify(gameData));
            window.location.href = 'board_3d.html?session=' + sessionCode + '&multiplayer=true&host=true';
        }

        function getAvatarEmoji(id) {
            if (!id || id === 'custom') return 'üéÆ';
            return id;
        }

        function escapeHtml(text) {
            var div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // =================================================================
        // SHARE / INVITE
        // =================================================================
        function getShareData() {
            var code = sessionCode || '------';
            var link = window.location.origin + '/fasttrack/join.html?code=' + code;
            var title = 'Join my FastTrack game!';
            var text = 'üéÆ Let\'s play FastTrack together!\n\nüîó Join here: ' + link + '\n\nüé´ Game Code: ' + code + '\n\nIt\'s a fun competitive board game - see you there!';
            return { code: code, link: link, title: title, text: text };
        }

        function copyCode() {
            navigator.clipboard.writeText(sessionCode).then(function() { showToast('Code copied!', 'success'); });
        }

        function copyLink() {
            var data = getShareData();
            navigator.clipboard.writeText(data.link).then(function() { showToast('Link copied!', 'success'); });
        }

        function showInviteModal() {
            var modal = document.getElementById('invite-modal');
            var nativeBtn = document.getElementById('native-share-btn');
            nativeBtn.style.display = navigator.share ? 'flex' : 'none';
            modal.classList.add('active');
        }

        function closeInviteModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('invite-modal').classList.remove('active');
        }

        function shareNative() {
            var data = getShareData();
            navigator.share({ title: data.title, text: data.text, url: data.link }).then(function() {
                closeInviteModal();
            }).catch(function() {});
        }

        function shareWhatsApp() {
            var data = getShareData();
            window.open('https://wa.me/?text=' + encodeURIComponent(data.text), '_blank');
            closeInviteModal();
        }

        function shareTelegram() {
            var data = getShareData();
            window.open('https://t.me/share/url?url=' + encodeURIComponent(data.link) + '&text=' + encodeURIComponent(data.text), '_blank');
            closeInviteModal();
        }

        function shareTwitter() {
            var data = getShareData();
            var tweet = 'üéÆ Let\'s play FastTrack! Join my game with code: ' + sessionCode;
            window.open('https://twitter.com/intent/tweet?text=' + encodeURIComponent(tweet) + '&url=' + encodeURIComponent(data.link), '_blank');
            closeInviteModal();
        }

        function shareFacebook() {
            var data = getShareData();
            window.open('https://www.facebook.com/sharer/sharer.php?u=' + encodeURIComponent(data.link), '_blank');
            closeInviteModal();
        }

        function shareSMS() {
            var data = getShareData();
            window.location.href = 'sms:?body=' + encodeURIComponent(data.text);
            closeInviteModal();
        }

        function shareEmail() {
            var data = getShareData();
            var subject = 'Join my FastTrack game! (Code: ' + data.code + ')';
            window.location.href = 'mailto:?subject=' + encodeURIComponent(subject) + '&body=' + encodeURIComponent(data.text);
            closeInviteModal();
        }

        // =================================================================
        // INIT
        // =================================================================
        document.addEventListener('DOMContentLoaded', function() {
            renderAvatarGrid();

            // Restore username from last session
            var saved = localStorage.getItem('fasttrack_username');
            if (saved) {
                document.getElementById('create-username').value = saved;
            }

            // Save username on input
            document.getElementById('create-username').addEventListener('input', function(e) {
                localStorage.setItem('fasttrack_username', e.target.value.trim());
            });
        });
    </script>
</body>
</html>
